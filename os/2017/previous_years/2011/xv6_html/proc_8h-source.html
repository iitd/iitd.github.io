<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>xv6: xv6/proc.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>xv6/proc.h</h1><a href="proc_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// Segments in proc-&gt;gdt.</span>
<a name="l00002"></a>00002 <span class="comment">// Also known to bootasm.S and trapasm.S</span>
<a name="l00003"></a><a class="code" href="proc_8h.html#0d4e0c4c738af60d6092941469642429">00003</a> <span class="preprocessor">#define SEG_KCODE 1  // kernel code</span>
<a name="l00004"></a><a class="code" href="proc_8h.html#d523d10217ef0ff5e75b7831f251d2b1">00004</a> <span class="preprocessor"></span><span class="preprocessor">#define SEG_KDATA 2  // kernel data+stack</span>
<a name="l00005"></a><a class="code" href="proc_8h.html#82120ac49072169c6f53657dc4b99e07">00005</a> <span class="preprocessor"></span><span class="preprocessor">#define SEG_KCPU  3  // kernel per-cpu data</span>
<a name="l00006"></a><a class="code" href="proc_8h.html#85b694d969eb01e547197c21db219f4b">00006</a> <span class="preprocessor"></span><span class="preprocessor">#define SEG_UCODE 4</span>
<a name="l00007"></a><a class="code" href="proc_8h.html#ba0495696b4c656fda31704782648461">00007</a> <span class="preprocessor"></span><span class="preprocessor">#define SEG_UDATA 5</span>
<a name="l00008"></a><a class="code" href="proc_8h.html#51332450caa8201ecc42fce428288e6f">00008</a> <span class="preprocessor"></span><span class="preprocessor">#define SEG_TSS   6  // this process's task state</span>
<a name="l00009"></a><a class="code" href="proc_8h.html#2fca412c6ed6584438e96f43ccce030a">00009</a> <span class="preprocessor"></span><span class="preprocessor">#define NSEGS     7</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span>
<a name="l00011"></a>00011 <span class="comment">// Saved registers for kernel context switches.</span>
<a name="l00012"></a>00012 <span class="comment">// Don't need to save all the segment registers (%cs, etc),</span>
<a name="l00013"></a>00013 <span class="comment">// because they are constant across kernel contexts.</span>
<a name="l00014"></a>00014 <span class="comment">// Don't need to save %eax, %ecx, %edx, because the</span>
<a name="l00015"></a>00015 <span class="comment">// x86 convention is that the caller has saved them.</span>
<a name="l00016"></a>00016 <span class="comment">// Contexts are stored at the bottom of the stack they</span>
<a name="l00017"></a>00017 <span class="comment">// describe; the stack pointer is the address of the context.</span>
<a name="l00018"></a>00018 <span class="comment">// The layout of the context must match the code in swtch.S.</span>
<a name="l00019"></a><a class="code" href="structcontext.html">00019</a> <span class="keyword">struct </span><a class="code" href="structcontext.html">context</a> {
<a name="l00020"></a><a class="code" href="structcontext.html#9c926d583d00a615327b9b4a8fe0ab63">00020</a>   <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structcontext.html#9c926d583d00a615327b9b4a8fe0ab63">edi</a>;
<a name="l00021"></a><a class="code" href="structcontext.html#9596ea769c8681490bbc67fd1b0abc92">00021</a>   <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structcontext.html#9596ea769c8681490bbc67fd1b0abc92">esi</a>;
<a name="l00022"></a><a class="code" href="structcontext.html#b1dd54ca1266e38df5943750224cd8d5">00022</a>   <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structcontext.html#b1dd54ca1266e38df5943750224cd8d5">ebx</a>;
<a name="l00023"></a><a class="code" href="structcontext.html#c9640ddc2e90e4213ba9847bbe1b0e57">00023</a>   <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structcontext.html#c9640ddc2e90e4213ba9847bbe1b0e57">ebp</a>;
<a name="l00024"></a><a class="code" href="structcontext.html#0cfb49e5b03fd7bf12fa79d1a42be935">00024</a>   <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structcontext.html#0cfb49e5b03fd7bf12fa79d1a42be935">eip</a>;
<a name="l00025"></a>00025 };
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba75dfb36109b24f39d54d5c3f48f53def8">00027</a> <span class="keyword">enum</span> <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba7">procstate</a> { <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba7a09b651ef326a9d8efcee5cc5b720ab4">UNUSED</a>, <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba7aed0f3d976d25b54cb7c895ce591febb">EMBRYO</a>, <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba7488282601451a751e0f0e770b15d4235">SLEEPING</a>, <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba7269b90433e40460a2c0044a0b3e15694">RUNNABLE</a>, <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba71061be6c3fb88d32829cba6f6b2be304">RUNNING</a>, <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba75dfb36109b24f39d54d5c3f48f53def8">ZOMBIE</a> };
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">// Per-process state</span>
<a name="l00030"></a><a class="code" href="structproc.html">00030</a> <span class="keyword">struct </span><a class="code" href="structproc.html">proc</a> {
<a name="l00031"></a><a class="code" href="structproc.html#961ca170857eafa41549be5d232480a1">00031</a>   <span class="keywordtype">char</span> *<a class="code" href="structproc.html#961ca170857eafa41549be5d232480a1">mem</a>;                   <span class="comment">// Start of process memory (kernel address)</span>
<a name="l00032"></a><a class="code" href="structproc.html#6e67042bb361124ff287af88efc33e00">00032</a>   <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structproc.html#6e67042bb361124ff287af88efc33e00">sz</a>;                     <span class="comment">// Size of process memory (bytes)</span>
<a name="l00033"></a><a class="code" href="structproc.html#9f556df98482bff6c9216013d7581ae4">00033</a>   <span class="keywordtype">char</span> *<a class="code" href="structproc.html#9f556df98482bff6c9216013d7581ae4">kstack</a>;                <span class="comment">// Bottom of kernel stack for this process</span>
<a name="l00034"></a><a class="code" href="structproc.html#0f2fe91548a1382672ae26e29ca9e736">00034</a>   <span class="keyword">enum</span> <a class="code" href="proc_8h.html#a1ced7d2b60040fded3fa873d0c03ba7">procstate</a> <a class="code" href="structproc.html#0f2fe91548a1382672ae26e29ca9e736">state</a>;        <span class="comment">// Process state</span>
<a name="l00035"></a><a class="code" href="structproc.html#304612ef6597fae1feb3bc14eccdf314">00035</a>   <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="structproc.html#304612ef6597fae1feb3bc14eccdf314">pid</a>;            <span class="comment">// Process ID</span>
<a name="l00036"></a><a class="code" href="structproc.html#14ea8849701ffafba4d142725de154d4">00036</a>   <span class="keyword">struct </span><a class="code" href="structproc.html">proc</a> *<a class="code" href="structproc.html#14ea8849701ffafba4d142725de154d4">parent</a>;         <span class="comment">// Parent process</span>
<a name="l00037"></a><a class="code" href="structproc.html#56ec07ac1e10ce42adfc8dd2a366071f">00037</a>   <span class="keyword">struct </span><a class="code" href="structtrapframe.html">trapframe</a> *<a class="code" href="structproc.html#56ec07ac1e10ce42adfc8dd2a366071f">tf</a>;        <span class="comment">// Trap frame for current syscall</span>
<a name="l00038"></a><a class="code" href="structproc.html#e0d9bffe1ad1c7d60dd2733be0a2333c">00038</a>   <span class="keyword">struct </span><a class="code" href="structcontext.html">context</a> *<a class="code" href="structcontext.html">context</a>;     <span class="comment">// Switch here to run process</span>
<a name="l00039"></a><a class="code" href="structproc.html#03048a49756c2243576208ba4ec5fbd4">00039</a>   <span class="keywordtype">void</span> *<a class="code" href="structproc.html#03048a49756c2243576208ba4ec5fbd4">chan</a>;                  <span class="comment">// If non-zero, sleeping on chan</span>
<a name="l00040"></a><a class="code" href="structproc.html#fb4f94a3f4df9a835dbb41b0c26660a4">00040</a>   <span class="keywordtype">int</span> <a class="code" href="structproc.html#fb4f94a3f4df9a835dbb41b0c26660a4">killed</a>;                  <span class="comment">// If non-zero, have been killed</span>
<a name="l00041"></a><a class="code" href="structproc.html#4a9eb0352efe3fc097c91fccfaac50bd">00041</a>   <span class="keyword">struct </span><a class="code" href="structfile.html">file</a> *<a class="code" href="structproc.html#4a9eb0352efe3fc097c91fccfaac50bd">ofile</a>[<a class="code" href="param_8h.html#80bacbaea8dd6aecf216d85d981bcb21">NOFILE</a>];  <span class="comment">// Open files</span>
<a name="l00042"></a><a class="code" href="structproc.html#493bc338ce008a838eef521972a35257">00042</a>   <span class="keyword">struct </span><a class="code" href="structinode.html">inode</a> *<a class="code" href="structproc.html#493bc338ce008a838eef521972a35257">cwd</a>;           <span class="comment">// Current directory</span>
<a name="l00043"></a><a class="code" href="structproc.html#c04af53e17d24b90c3cbfab56d658d62">00043</a>   <span class="keywordtype">char</span> <a class="code" href="structproc.html#c04af53e17d24b90c3cbfab56d658d62">name</a>[16];               <span class="comment">// Process name (debugging)</span>
<a name="l00044"></a>00044 };
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// Process memory is laid out contiguously, low addresses first:</span>
<a name="l00047"></a>00047 <span class="comment">//   text</span>
<a name="l00048"></a>00048 <span class="comment">//   original data and bss</span>
<a name="l00049"></a>00049 <span class="comment">//   fixed-size stack</span>
<a name="l00050"></a>00050 <span class="comment">//   expandable heap</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="comment">// Per-CPU state</span>
<a name="l00053"></a><a class="code" href="structcpu.html">00053</a> <span class="keyword">struct </span><a class="code" href="structcpu.html">cpu</a> {
<a name="l00054"></a><a class="code" href="structcpu.html#197e14f88e97fc3b2e12c613f7e0a9e3">00054</a>   <a class="code" href="types_8h.html#65f85814a8290f9797005d3b28e7e5fc">uchar</a> <a class="code" href="structcpu.html#197e14f88e97fc3b2e12c613f7e0a9e3">id</a>;                    <span class="comment">// Local APIC ID; index into cpus[] below</span>
<a name="l00055"></a><a class="code" href="structcpu.html#aa1510fdf8a2230c033d04e13e4fdd9e">00055</a>   <span class="keyword">struct </span><a class="code" href="structcontext.html">context</a> *<a class="code" href="structcpu.html#aa1510fdf8a2230c033d04e13e4fdd9e">scheduler</a>;   <span class="comment">// Switch here to enter scheduler</span>
<a name="l00056"></a><a class="code" href="structcpu.html#32e7b5aa877171c943d47038e818a159">00056</a>   <span class="keyword">struct </span><a class="code" href="structtaskstate.html">taskstate</a> <a class="code" href="structcpu.html#32e7b5aa877171c943d47038e818a159">ts</a>;         <span class="comment">// Used by x86 to find stack for interrupt</span>
<a name="l00057"></a><a class="code" href="structcpu.html#ee38fb8832f8e728538b2cee877d1c09">00057</a>   <span class="keyword">struct </span><a class="code" href="structsegdesc.html">segdesc</a> <a class="code" href="structcpu.html#ee38fb8832f8e728538b2cee877d1c09">gdt</a>[<a class="code" href="proc_8h.html#2fca412c6ed6584438e96f43ccce030a">NSEGS</a>];   <span class="comment">// x86 global descriptor table</span>
<a name="l00058"></a><a class="code" href="structcpu.html#a7dd483d406944ef51b7ab4027f4117f">00058</a>   <span class="keyword">volatile</span> <a class="code" href="types_8h.html#91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> <a class="code" href="structcpu.html#a7dd483d406944ef51b7ab4027f4117f">booted</a>;        <span class="comment">// Has the CPU started?</span>
<a name="l00059"></a><a class="code" href="structcpu.html#9ccad8ae031c295f86e96de26df24805">00059</a>   <span class="keywordtype">int</span> <a class="code" href="structcpu.html#9ccad8ae031c295f86e96de26df24805">ncli</a>;                    <span class="comment">// Depth of pushcli nesting.</span>
<a name="l00060"></a><a class="code" href="structcpu.html#26fc271fea8af30d67fc2ae22ef0a82f">00060</a>   <span class="keywordtype">int</span> <a class="code" href="structcpu.html#26fc271fea8af30d67fc2ae22ef0a82f">intena</a>;                  <span class="comment">// Were interrupts enabled before pushcli?</span>
<a name="l00061"></a>00061   
<a name="l00062"></a>00062   <span class="comment">// Cpu-local storage variables; see below</span>
<a name="l00063"></a><a class="code" href="structcpu.html#96823491c316b96bdd2fb80fa8e270f9">00063</a>   <span class="keyword">struct </span><a class="code" href="structcpu.html">cpu</a> *<a class="code" href="structcpu.html">cpu</a>;
<a name="l00064"></a><a class="code" href="structcpu.html#9e71a6265904fd644875a9ea5a413c89">00064</a>   <span class="keyword">struct </span><a class="code" href="structproc.html">proc</a> *<a class="code" href="structproc.html">proc</a>;
<a name="l00065"></a>00065 };
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structcpu.html">cpu</a> <a class="code" href="mp_8c.html#6d2633e73724907b582dfe6938ed7bb9">cpus</a>[<a class="code" href="param_8h.html#2c4561c4c17cde39101c4e7a40d4492a">NCPU</a>];
<a name="l00068"></a>00068 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="mp_8c.html#6201a0661c3d5b88df5f63529298eb48">ncpu</a>;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">// Per-CPU variables, holding pointers to the</span>
<a name="l00071"></a>00071 <span class="comment">// current cpu and to the current process.</span>
<a name="l00072"></a>00072 <span class="comment">// The asm suffix tells gcc to use "%gs:0" to refer to cpu</span>
<a name="l00073"></a>00073 <span class="comment">// and "%gs:4" to refer to proc.  ksegment sets up the</span>
<a name="l00074"></a>00074 <span class="comment">// %gs segment register so that %gs refers to the memory</span>
<a name="l00075"></a>00075 <span class="comment">// holding those two variables in the local cpu's struct cpu.</span>
<a name="l00076"></a>00076 <span class="comment">// This is similar to how thread-local variables are implemented</span>
<a name="l00077"></a>00077 <span class="comment">// in thread libraries such as Linux pthreads.</span>
<a name="l00078"></a>00078 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structcpu.html">cpu</a> *<a class="code" href="structcpu.html">cpu</a> <span class="keyword">asm</span>(<span class="stringliteral">"%gs:0"</span>);       <span class="comment">// This cpu.</span>
<a name="l00079"></a>00079 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="structproc.html">proc</a> *<a class="code" href="structproc.html">proc</a> <span class="keyword">asm</span>(<span class="stringliteral">"%gs:4"</span>);     <span class="comment">// Current proc on this cpu.</span>
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Jan 7 12:25:49 2011 for xv6 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
